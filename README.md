# Описание
Цифровая модель для динамической идентификации промышленных источников выбросов
и прогнозирования пространственного распределения вредных веществ в атмосферном воздухе.

# Состав ПО с указанием docker-контейнеров
1. База данных временных рядов для хранения измерений (influxdb_container).
2. База данных справочников для хранения паспортных данные по ВВ, ИЗА и постам контроля.
3. Компьютерные вычислительные модели:
    3.1.  прогнозирования;
    3.2.  рассеивания (internal-app);
    3.3.  идентификации источника.
4. Средства визуализации табличных данных, графиков измерений и карт (grafana_container).
5. Прототип личного кабинета (php-eco)

# Подготовка
Произвести установку на локальной машине Docker, Docker Compose или Docker Engine не ниже версии 25.
Все окружение для проекта реализовано посредством docker-контейнеров. При этом с целью гибкой конфигурации, а также возможности просматривать
работу вышеуказанных компонентов, файлы настройки, папки с данными а также журналы монтируются с файловой системой вашего компьютера. 
Базовая папка в зависимости от [ОС](#термины-и-сокращения) располагается:

- Linux: /opt
- Windows: c:/opt

Скопируйте в данную целевую папку следующие каталоги из проекта вместе со всем их содержимым и переименуйте их как указано в таблице ниже:

| Наименование папки <br/>в [$HOME](#термины-и-сокращения) | Наименование в целевой папке |
|----------------------------------------------------------|------------------------------|
| gral_gramm_w_files5/Data                                 | data                         |
| gral_gramm_w_files5/Meteo                                | meteo                        |
| gral_gramm_w_files5/proj                                 | proj                         | 
| postgres-docker/backup                                   | postgres/backup              | 

Данные папки являются точками монтирования и служат для коммуникации данных между docker-контейнерами 

# Описание окружения
Переменные окружения заданы в файле [$HOME](#термины-и-сокращения)\.env

| Наименование | Значение                                                   | Описание                                                                                           |
|--------------|------------------------------------------------------------|----------------------------------------------------------------------------------------------------|
|ROOM_HOST| 127.0.0.1                                                  | Задание IP DNS - docker-контейнеров                                                                |
|APACHE_SERVER_NAME| php-eco                                                    | Задание базового (не виртуального) имени сервера Apache внутри контейнера                          |
|PHP_ECO_PORT| 8001                                                       | внешний порт Личного кабинета (далее ЛК) на хост машине                                            | 
|APP_PORT| 5000                                                       | внешний порт internal-app на хост машине                                                           |
|GRAL_SERVER| http://internal-app:$APP_PORT                              | задание url для запросов к internal-app из ЛК                                                      |                        
|GRAL_RESULT| http://$ROOM_HOST:$PHP_ECO_PORT/Data/output.csv            | задание url-адреса данных с расчетами                                                              |
|GRAL_RESULT_EMISSION| http://$ROOM_HOST:$PHP_ECO_PORT/Proj/csvfile_emissoins.csv | задание url-адреса данных с расчетами эмиссии                                                      |
|GRAL_RESULT_ZIP| http://$ROOM_HOST:$PHP_ECO_PORT/Proj/test.zip              | задание url-адреса данных с расчетами модели Граля                                                 |
|GRAL_RESULT_SVG| http://$ROOM_HOST:$PHP_ECO_PORT/Proj/out.svg               | задание url-адреса графики с расчетами модели Граля                                                
|STREAM_LEAT| https://ql.zedpost.ru/                                     | задание url-адреса для вызова Стримлита                                                            |
|GRALPATH| /soft/gral/                                                | задание папки внутри контейнера internal-app где размещаются данные для модели Граля               | 
|GRAMMPATH| /soft/gramm/                                               | задание папки внутри контейнера internal-app где размещаются данные для модели Грамм               |
|HOST| 0.0.0.0                                                    | задание адреса для сервиса internal-app внутри контейнера                                          |
|GRAFANA| http://127.0.0.1:3001                                      | url-адрес обращения к дашбордам Grafana из ЛК                                                      |
|DB_HOST| postgres_docker                                            | задание адреса хоста БД из ЛК                                                                      | 
|DB_PORT| 5532                                                       | задание порта БД из ЛК                                                                             |
|DB_NAME| eco                                                        | задание имени БД из ЛК                                                                             |
|DB_USER| postgres                                                   | задание имени пользователя БД из ЛК                                                                |
|DB_PASSWORD| tkk2023                                                    | задание пароля пользователя БД из ЛК                                                               |
|POSTGRES_PASSWORD| tkk2023                                                    | задание пароля пользователя БД на уровне docker_container при инициализации БД                     |
|PGPASSWORD| /var/lib/postgres/.pgpass                                  | задание паролей для скриптов резервного копирования и восстановления БД на уровне docker_container |
|BACKUP_FILE| eco-16-06-23.sql                                           | задание имени файла с резервной копией на уровне docker_container при инициализации БД             |
|PGDATA| /var/lib/postgresql/data/pgdata/                           | задание пути к БД на уровне docker_container для инициализации БД                                  |
|DOCKER_INFLUXDB_INIT_BUCKET| eco                                                        | задание имени БД Influxdb                                                                          |
|DOCKER_INFLUXDB_INIT_USERNAME| eco_user                                                   | задание имени пользоателя БД Influxdb                                                              |
|DOCKER_INFLUXDB_INIT_PASSWORD| eco_user                                                   | задание пароля пользоателя БД Influxdb                                                             |
|BACKUP_PATH| backup                                                     | Наименование папки с резервной копией БД                                                           |


# Сборка
для Linux
```bash
docker compose --progress=plain build --build-arg APACHE_HOST_ARG=php-eco
```
для Windows
```bash
docker compose -f docker-compose-windows.yml --progress=plain build --build-arg APACHE_HOST_ARG=php-eco
```

# Запуск
Для создания и запуска docker-контейнеров из каталога [$HOME](#термины-и-сокращения) 
в зависимости от ОС вашего компьютера выполнить следующее:

для Linux
```bash
docker compose up -d
```
для Windows
```bash
docker compose -f docker-compose-windows.yml up -d
```

# Останов
для Linux, Windows
```bash
docker compose down
```

## Восстановление БД Postgres
В составе ПО предусмотрен бэкап БД для автоматической инициализации БД при первоначальном запуске.
БД eco будет автоматически создана при запуске postgres-container. Данная операция выполняется однократно
при первом запуске и создании volume. В случае если требуется заново
проинициализировать БД для этого необходимо выполнить следующее:
1. остановить и уничтожить [docker-контейнеры](#останов)
2. удалить volume postgres_data
```bash
docker volume rm postgres_data
```
3. произвести [запуск](#запуск)

## Резервное копирование БД
Для выполнения резервного копирования выполнить след. команду:
```bash
docker exec -it influxdb-container /backup_influxdb.sh
```
После чего в каталоге /opt/influxdb/backup будет содержаться резервная копия БД 

# Вход в личный кабинет
Вход осуществляется по ссылке: http://127.0.0.1:8001/
Логин: admin
Пароль: 147258369

# Термины и сокращения
| Наименование | Описание                                                                        |
|------|---------------------------------------------------------------------------------|
| СУБД | Средство управления базами данных                                               |
| ОС   | Операционная система                                                            |
| $HOME | Обозначение каталога который содержит склонированный <br/>из репозитория проект |
